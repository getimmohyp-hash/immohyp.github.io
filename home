
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Property Investment Checker v3.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --bg-card: #020617;
      --bg-soft: #111827;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.1);
      --accent-warn: #eab308;
      --accent-bad: #ef4444;
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --border: #1f2937;
      --radius-lg: 16px;
      --radius-full: 999px;
      --shadow-soft: 0 18px 45px rgba(0, 0, 0, 0.65);
      --transition: 180ms ease-out;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2937, #020617 45%);
      color: var(--text);
      padding: 24px;
      display: flex;
      align-items: stretch;
      justify-content: center;
    }

    .app {
      width: 100%;
      max-width: 1120px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }

    .title-group h1 {
      margin: 0;
      font-size: 1.8rem;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .title-pill {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      padding: 4px 10px;
      border-radius: var(--radius-full);
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--text-muted);
    }

    .subtitle {
      margin-top: 6px;
      font-size: 0.9rem;
      color: var(--text-muted);
    }

    .badge-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 11px;
      border-radius: var(--radius-full);
      background: rgba(15, 23, 42, 0.7);
      border: 1px solid rgba(31, 41, 55, 0.9);
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .badge-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.8);
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 1.35fr) minmax(0, 1fr);
      gap: 20px;
      align-items: flex-start;
    }

    @media (max-width: 900px) {
      main {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), #020617);
      border-radius: var(--radius-lg);
      padding: 18px 18px 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(
        circle at top left,
        rgba(56, 189, 248, 0.12),
        transparent 60%
      );
      opacity: 0.4;
      pointer-events: none;
    }

    .card > * {
      position: relative;
      z-index: 1;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 8px;
    }

    .card-header h2 {
      margin: 0;
      font-size: 1.02rem;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #e5e7eb;
    }

    .card-tag {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      opacity: 0.85;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px 14px;
      margin-top: 8px;
    }

    @media (max-width: 700px) {
      .form-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.85rem;
    }

    label {
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 6px;
      align-items: center;
    }

    label span {
      font-weight: 500;
    }

    label small {
      font-size: 0.72rem;
      opacity: 0.8;
    }

    input[type="number"],
    select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 7px 12px;
      background: rgba(15, 23, 42, 0.85);
      color: var(--text);
      font-size: 0.88rem;
      outline: none;
      transition: border-color var(--transition), box-shadow var(--transition),
        background var(--transition), transform var(--transition);
    }

    input[type="number"]:focus,
    select:focus {
      border-color: rgba(34, 197, 94, 0.9);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.5);
      background: #020617;
      transform: translateY(-1px);
    }

    input[type="number"]::placeholder {
      color: rgba(156, 163, 175, 0.7);
    }

    .input-suffix {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .suffix {
      font-size: 0.76rem;
      color: var(--text-muted);
      padding: 1px 7px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.95);
      white-space: nowrap;
    }

    .divider {
      margin: 10px 0;
      border-top: 1px dashed rgba(55, 65, 81, 0.9);
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 3px;
      font-size: 0.78rem;
    }

    .pill {
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 3px 7px;
      color: var(--text-muted);
      background: rgba(15, 23, 42, 0.85);
    }

    .actions {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    button {
      border-radius: 999px;
      padding: 8px 16px;
      border: none;
      cursor: pointer;
      font-size: 0.86rem;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform var(--transition), box-shadow var(--transition),
        filter var(--transition), background var(--transition);
    }

    .btn-primary {
      background: radial-gradient(circle at top left, #4ade80, #22c55e);
      color: #022c22;
      box-shadow: 0 14px 30px rgba(22, 163, 74, 0.5);
    }

    .btn-primary:hover {
      filter: brightness(1.06);
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(22, 163, 74, 0.6);
    }

    .btn-ghost {
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-muted);
      border: 1px solid rgba(55, 65, 81, 0.9);
    }

    .btn-ghost:hover {
      background: rgba(15, 23, 42, 1);
      transform: translateY(-1px);
    }

    .btn-primary-icon {
      font-size: 1rem;
      line-height: 1;
    }

    .results-grid {
      display: grid;
      grid-template-rows: auto auto;
      gap: 12px;
    }

    .ratio-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 10px;
      margin-top: 6px;
    }

    @media (max-width: 500px) {
      .ratio-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .metric {
      padding: 9px 10px;
      border-radius: 12px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(55, 65, 81, 0.95);
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-height: 58px;
    }

    .metric-label {
      font-size: 0.78rem;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 4px;
    }

    .metric-value {
      font-weight: 600;
      font-size: 1rem;
    }

    .metric-sub {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .metric-highlight {
      border-color: rgba(34, 197, 94, 0.6);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.35);
      background: linear-gradient(
        135deg,
        rgba(22, 163, 74, 0.12),
        rgba(15, 23, 42, 0.96)
      );
    }

    .metric-warning {
      border-color: rgba(234, 179, 8, 0.6);
    }

    .metric-bad {
      border-color: rgba(239, 68, 68, 0.6);
    }

    .verdict {
      margin-top: 10px;
      padding: 9px 11px;
      border-radius: 14px;
      background: radial-gradient(circle at top, #16a34a22, #020617);
      border: 1px solid rgba(34, 197, 94, 0.7);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .verdict-line {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
    }

    .verdict-chip {
      border-radius: 999px;
      padding: 3px 9px;
      font-size: 0.78rem;
      font-weight: 600;
      background: var(--accent-soft);
      color: #bbf7d0;
      border: 1px solid rgba(22, 163, 74, 0.8);
    }

    .verdict-text {
      font-size: 0.82rem;
      color: var(--text-muted);
    }

    .verdict-bad {
      border-color: rgba(239, 68, 68, 0.8);
      background: radial-gradient(circle at top, #b91c1c22, #020617);
    }

    .verdict-bad .verdict-chip {
      background: rgba(239, 68, 68, 0.12);
      border-color: rgba(239, 68, 68, 0.8);
      color: #fecaca;
    }

    .verdict-warning {
      border-color: rgba(234, 179, 8, 0.8);
      background: radial-gradient(circle at top, #ca8a0422, #020617);
    }

    .verdict-warning .verdict-chip {
      background: rgba(234, 179, 8, 0.12);
      border-color: rgba(234, 179, 8, 0.8);
      color: #fef3c7;
    }

    .small-note {
      margin-top: 6px;
      font-size: 0.75rem;
      color: var(--text-muted);
      opacity: 0.9;
    }

    .info-note {
      margin-top: 4px;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .section-box {
      margin-top: 8px;
      padding: 10px 11px;
      border-radius: 14px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: radial-gradient(
        circle at top,
        rgba(15, 118, 110, 0.2),
        rgba(15, 23, 42, 0.95)
      );
    }

    .section-title {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .amort-section {
      margin-top: 10px;
      padding: 10px 11px;
      border-radius: 14px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: radial-gradient(
        circle at top,
        rgba(30, 64, 175, 0.26),
        #020617
      );
      font-size: 0.8rem;
    }

    .amort-title {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .amort-subtext {
      font-size: 0.78rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    details {
      margin-top: 6px;
    }

    details summary {
      cursor: pointer;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    .table-wrapper {
      max-height: 220px;
      overflow: auto;
      margin-top: 6px;
      border-radius: 8px;
      border: 1px solid rgba(55, 65, 81, 0.7);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.78rem;
    }

    th,
    td {
      padding: 4px 6px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.8);
      text-align: right;
      white-space: nowrap;
    }

    th:first-child,
    td:first-child {
      text-align: left;
    }

    .hidden {
      display: none !important;
    }

    /* ================================
       MINI HEATMAP STYLE + MARKER
       ================================ */

    .heatmap-bar {
      margin-top: 6px;
      position: relative;
      height: 28px;
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      border: 1px solid rgba(55, 65, 81, 0.9);
    }

    .heatmap-seg {
      flex: 1;
    }

    .heat-red   { background: #e02424; }
    .heat-orange{ background: #f59e0b; }
    .heat-yellow{ background: #facc15; }
    .heat-green { background: #22c55e; }
    .heat-blue  { background: #3b82f6; }

    /* Marker */
    #miniHeatmapMarker {
      position: absolute;
      top: 50%;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 3px solid white;
      background: rgba(255,255,255,0.9);
      transform: translate(-50%, -50%);
      display: none;
      box-shadow: 0 0 12px rgba(255,255,255,0.7), 0 0 16px rgba(0,0,0,0.55);
      animation: pulseMarker 1.8s infinite ease-in-out;
    }

    @keyframes pulseMarker {
      0%   { transform: translate(-50%, -50%) scale(1);   opacity: 1; }
      50%  { transform: translate(-50%, -50%) scale(1.25); opacity: 0.75; }
      100% { transform: translate(-50%, -50%) scale(1);   opacity: 1; }
    }

    .section-box-miniheat {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(55,65,81,0.85);
      background: radial-gradient(circle at top, rgba(34,197,94,0.15), rgba(15,23,42,0.95));
    }

    .section-title-miniheat {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text);
    }

    /* ====== DARK/LIGHT SWITCH ======= */
.switch {
  position: relative;
  display: inline-block;
  width: 46px;
  height: 24px;
}
.switch input { display: none; }

.slider {
  position: absolute;
  cursor: pointer;
  top: 0; left: 0; right: 0; bottom: 0;
  background-color: #555;
  border-radius: 34px;
  transition: .4s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 18px;
  width: 18px;
  left: 3px;
  bottom: 3px;
  background-color: white;
  border-radius: 50%;
  transition: .4s;
}

/* Aktiv */
input:checked + .slider {
  background-color: #22c55e;
}
input:checked + .slider:before {
  transform: translateX(22px);
}

/* LIGHT MODE ROOT VARS */
.light {
  --bg: #f8fafc;
  --bg-card: #ffffff;
  --bg-soft: #e2e8f0;
  --text: #1e293b;
  --text-muted: #475569;
  --border: #cbd5e1;
  --accent: #16a34a;
  --accent-soft: rgba(16, 185, 129, 0.1);
  background: #f1f5f9 !important;
}

  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title-group">
        <h1>
          Property Investment Checker
          <span class="title-pill">Yield ¬∑ Cashflow ¬∑ Tilgungsplan</span>
        </h1>
        <p class="subtitle">
          Schnell-Check: Kaufpreis, Nebenkosten, Darlehen, R√ºcklagen, AfA & Sondertilgung ‚Äì
          um zu sehen, ob der Deal eher <strong>‚ÄûCashflow-Kandidat‚Äú</strong> oder
          <strong>‚ÄûWarnsignal‚Äú</strong> ist.
        </p>
      </div>
      <div class="badge-row">
        <div class="badge">
          <span class="badge-dot"></span> Brutto- & Nettorendite
        </div>
        <div class="badge">
          Nebenkosten & Gesamtkosten
        </div>
        <div class="badge">
          Cashflow, ROE & Tilgungsplan
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:10px;">
  <label class="switch">
    <input type="checkbox" id="themeToggle">
    <span class="slider"></span>
  </label>
</div>
    </header>

    <main>
      <!-- INPUT CARD -->
      <section class="card">
        <div class="card-header">
          <h2>Inputs</h2>
          <span class="card-tag">Objekt ¬∑ Nebenkosten ¬∑ Finanzierung</span>
        </div>

        <form id="investment-form">
          <div class="pill-row">
            <span class="pill">Step 1: Objekt & Miete</span>
            <span class="pill">Step 2: Nebenkosten & EK</span>
            <span class="pill">Step 3: Darlehen & R√ºcklagen</span>
            <span class="pill">Step 4: AfA & Steuer</span>
          </div>

          <div class="divider"></div>

          <!-- BASIC PROPERTY & RENT -->
          <div class="form-grid">
            <div class="field">
              <label for="purchasePrice">
                <span>Kaufpreis</span>
                <small>ohne Nebenkosten</small>
              </label>
              <div class="input-suffix">
                <input
                  type="number"
                  id="purchasePrice"
                  step="1000"
                  placeholder="z. B. 300000"
                  required
                />
                <span class="suffix">‚Ç¨</span>
              </div>
            </div>

            <div class="field">
              <label for="equity">
                <span>Eigenkapital</span>
                <small>f√ºr KP & ggf. NK</small>
              </label>
              <div class="input-suffix">
                <input
                  type="number"
                  id="equity"
                  step="500"
                  placeholder="z. B. 60000"
                />
                <span class="suffix">‚Ç¨</span>
              </div>
            </div>

            <div class="field">
              <label for="coldRentMonth">
                <span>Kaltmiete (Monat)</span>
                <small>Mieteinnahmen</small>
              </label>
              <div class="input-suffix">
                <input
                  type="number"
                  id="coldRentMonth"
                  step="10"
                  placeholder="z. B. 900"
                  required
                />
                <span class="suffix">‚Ç¨/Monat</span>
              </div>
            </div>

            <div class="field">
              <label for="hausgeld">
                <span>Hausgeld (Monat)</span>
                <small>nicht umlagef√§higer Anteil</small>
              </label>
              <div class="input-suffix">
                <input
                  type="number"
                  id="hausgeld"
                  step="5"
                  placeholder="z. B. 220"
                />
                <span class="suffix">‚Ç¨/Monat</span>
              </div>
            </div>

            <div class="field">
              <label for="livingSpace">
                <span>Wohnfl√§che</span>
                <small>f√ºr ‚Ç¨/m¬≤ & R√ºcklagen</small>
              </label>
              <div class="input-suffix">
                <input
                  type="number"
                  id="livingSpace"
                  step="0.5"
                  placeholder="z. B. 65"
                  required
                />
                <span class="suffix">m¬≤</span>
              </div>
            </div>

            <div class="field">
              <label for="constructionYear">
                <span>Baujahr</span>
                <small>f√ºr R√ºcklagen-Benchmark</small>
              </label>
              <div class="input-suffix">
                <input
                  type="number"
                  id="constructionYear"
                  step="1"
                  placeholder="z. B. 1995"
                />
                <span class="suffix">Jahr</span>
              </div>
            </div>

            <!-- PLZ + MINI HEATMAP -->
            <div class="field">
              <label for="postcode">
                <span>Postleitzahl (PLZ)</span>
                <small>f√ºr Lage-Heatmap</small>
              </label>
              <div class="input-suffix">
                <input
                  type="number"
                  id="postcode"
                  step="1"
                  placeholder="z. B. 60311"
                />
                <span class="suffix">PLZ</span>
              </div>
            </div>

            <div class="section-box-miniheat" id="miniHeatmapSection">
              <div class="section-title-miniheat">üìä Mietnachfrage ‚Äì Mini Heatmap</div>

              <p class="info-note" id="miniHeatmapHint">
                Bitte PLZ eingeben, um Nachfragelevel zu berechnen.
              </p>

              <div class="heatmap-bar">
                <div class="heatmap-seg heat-red"></div>
                <div class="heatmap-seg heat-orange"></div>
                <div class="heatmap-seg heat-yellow"></div>
                <div class="heatmap-seg heat-green"></div>
                <div class="heatmap-seg heat-blue"></div>

                <div id="miniHeatmapMarker"></div>
              </div>

              <p class="info-note" id="miniHeatmapText" style="margin-top:6px;">
                Noch keine PLZ eingegeben.
              </p>
            </div>

            <div class="field">
              <label for="stateSelect">
                <span>Bundesland</span>
                <small>f√ºr GrESt-Satz</small>
              </label>
              <select id="stateSelect">
                <option value="">‚Äì ausw√§hlen ‚Äì</option>
                <option value="BW">Baden-W√ºrttemberg</option>
                <option value="BY">Bayern</option>
                <option value="BE">Berlin</option>
                <option value="BB">Brandenburg</option>
                <option value="HB">Bremen</option>
                <option value="HH">Hamburg</option>
                <option value="HE">Hessen</option>
                <option value="MV">Mecklenburg-Vorpommern</option>
                <option value="NI">Niedersachsen</option>
                <option value="NW">Nordrhein-Westfalen</option>
                <option value="RP">Rheinland-Pfalz</option>
                <option value="SL">Saarland</option>
                <option value="SN">Sachsen</option>
                <option value="ST">Sachsen-Anhalt</option>
                <option value="SH">Schleswig-Holstein</option>
                <option value="TH">Th√ºringen</option>
              </select>
            </div>
          </div>

          <div class="divider"></div>

          <!-- NEBENKOSTEN -->
          <div class="form-grid">
            <div class="field">
              <label for="grestPercent">
                <span>Grunderwerbsteuer</span>
                <small>% vom Kaufpreis</small>
              </label>
              <div class="input-suffix">
                <input
                  type="number"
                  id="grestPercent"
                  step="0.1"
                  placeholder="z. B. 6.0"
                />
                <span class="suffix">% KP</span>
              </div>
            </div>

            <div class="field">
              <label for="notarPercent">
                <span>Notarkosten</span>
                <small>typisch ca. 1,5 %</small>
              </label>
              <div class="input-suffix">
                <input
                  type="number"
                  id="notarPercent"
                  step="0.1"
                  placeholder="1.5"
                  value="1.5"
                />
                <span class="suffix">% KP</span>
              </div>
            </div>

            <div class="field">
              <label for="grundbuchPercent">
                <span>Grundbuchkosten</span>
                <small>typisch ca. 0,5 %</small>
              </label>
              <div class="input-suffix">
                <input
                  type="number"
                  id="grundbuchPercent"
                  step="0.1"
                  placeholder="0.5"
                  value="0.5"
                />
                <span class="suffix">% KP</span>
              </div>
            </div>

            <div class="field">
              <label for="maklerPercent">
                <span>Maklerprovision</span>
                <small>brutto, K√§uferanteil</small>
              </label>
              <div class="input-suffix">
                <input
                  type="number"
                  id="maklerPercent"
                  step="0.01"
                  placeholder="z. B. 3.57"
                />
                <span class="suffix">% KP</span>
              </div>
            </div>

            <div class="field">
              <label for="otherCosts">
                <span>Sonstige NK</span>
                <small>Gutachten, Umbau etc.</small>
              </label>
              <div class="input-suffix">
                <input
                  type="number"
                  id="otherCosts"
                  step="100"
                  placeholder="z. B. 5000"
                />
                <span class="suffix">‚Ç¨</span>
              </div>
            </div>

            <div class="field">
              <label>
                <span>NK-Hinweis</span>
                <small>vereinfachte K√§ufer-Sicht</small>
              </label>
              <div class="info-note">
                Nebenkosten werden aus Kaufpreis, Prozents√§tzen & sonstigen Kosten
                berechnet. Zur Vereinfachung hier komplett dem K√§ufer zugeordnet.
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <!-- LOAN & RESERVES -->
          <div class="form-grid">
            <div class="field">
              <label for="loanAmount">
                <span>Darlehenssumme</span>
                <small>optional (sonst: Gesamtkosten ‚àí EK)</small>
              </label>
              <div class="input-suffix">
                <input
                  type="number"
                  id="loanAmount"
                  step="1000"
                  placeholder="leer = auto-berechnet"
                />
                <span class="suffix">‚Ç¨</span>
              </div>
            </div>

            <div class="field">
              <label for="interestRate">
                <span>Zinssatz p.a.</span>
                <small>Sollzins</small>
              </label>
              <div class="input-suffix">
                <input
                  type="number"
                  id="interestRate"
                  step="0.01"
                  placeholder="z. B. 3.5"
                  required
                />
                <span class="suffix">% p.a.</span>
              </div>
            </div>

            <div class="field">
              <label for="principalRate">
                <span>Tilgung p.a.</span>
                <small>Anfangstilgung</small>
              </label>
              <div class="input-suffix">
                <input
                  type="number"
                  id="principalRate"
                  step="0.01"
                  placeholder="z. B. 2.0"
                />
                <span class="suffix">% p.a.</span>
              </div>
            </div>

            <div class="field">
              <label for="monthlyInstallment">
                <span>Annuit√§t (Monat)</span>
                <small>leer = aus Zins + Tilgung</small>
              </label>
              <div class="input-suffix">
                <input
                  type="number"
                  id="monthlyInstallment"
                  step="10"
                  placeholder="optional √ºberschreiben"
                />
                <span class="suffix">‚Ç¨/Monat</span>
              </div>
            </div>

            <div class="field">
              <label for="fixationYears">
                <span>Zinsbindung</span>
                <small>f√ºr Restschuld-Blick</small>
              </label>
              <div class="input-suffix">
                <input
                  type="number"
                  id="fixationYears"
                  step="1"
                  value="10"
                  placeholder="z. B. 10"
                />
                <span class="suffix">Jahre</span>
              </div>
            </div>

            <div class="field">
              <label for="reservesPerSqm">
                <span>R√ºcklage / m¬≤</span>
                <small>autom. Vorschlag nach Baujahr</small>
              </label>
              <div class="input-suffix">
                <input
                  type="number"
                  id="reservesPerSqm"
                  step="0.1"
                  placeholder="auto oder manuell"
                />
                <span class="suffix">‚Ç¨/m¬≤¬∑Monat</span>
              </div>
            </div>

            <div class="field">
              <label for="reservesMonthly">
                <span>Zus√§tzliche R√ºcklage</span>
                <small>pauschal / Monat</small>
              </label>
              <div class="input-suffix">
                <input
                  type="number"
                  id="reservesMonthly"
                  step="10"
                  placeholder="z. B. 50"
                />
                <span class="suffix">‚Ç¨/Monat</span>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <!-- SONDERTILGUNG SECTION -->
          <div class="section-box">
            <div class="section-title">
              üìå Sondertilgungsoptionen
            </div>
            <p class="info-note">
              Hinweis: Viele Banken erlauben max. 5&nbsp;% Sondertilgung p.a. bezogen auf
              die urspr√ºngliche Darlehenssumme. Hier kannst du das simulieren.
            </p>

            <div class="form-grid">
              <div class="field">
                <label for="prepaymentType">
                  <span>Art der Sondertilgung</span>
                  <small>bezogen auf Darlehenssumme</small>
                </label>
                <select id="prepaymentType">
                  <option value="none">Keine Sondertilgung</option>
                  <option value="pct5">5 % p.a. vom Darlehen</option>
                  <option value="pct2">2 % p.a. vom Darlehen</option>
                  <option value="pct10">10 % p.a. vom Darlehen</option>
                  <option value="fixed">Fester Betrag (‚Ç¨/Jahr)</option>
                </select>
              </div>

              <div class="field hidden" id="prepaymentFixedField">
                <label for="prepaymentFixed">
                  <span>Feste Sondertilgung</span>
                  <small>falls ‚Äûfester Betrag‚Äú</small>
                </label>
                <div class="input-suffix">
                  <input
                    type="number"
                    id="prepaymentFixed"
                    step="100"
                    placeholder="z. B. 3000"
                  />
                  <span class="suffix">‚Ç¨/Jahr</span>
                </div>
              </div>

              <div class="field">
                <label for="prepaymentYears">
                  <span>Nur in den ersten ‚Ä¶</span>
                  <small>0 = volle Laufzeit</small>
                </label>
                <div class="input-suffix">
                  <input
                    type="number"
                    id="prepaymentYears"
                    step="1"
                    placeholder="z. B. 10"
                  />
                  <span class="suffix">Jahre</span>
                </div>
              </div>

              <div class="field">
                <label>
                  <span>Berechnete Sondertilgung</span>
                  <small>pro Jahr</small>
                </label>
                <div class="info-note" id="prepaymentAmountInfo">
                  Keine Sondertilgung hinterlegt.
                </div>
              </div>
            </div>
          </div>

          <div class="divider"></div>

          <!-- AFA & TAX -->
          <div class="form-grid">
            <div class="field">
              <label for="buildingShare">
                <span>Geb√§udeanteil</span>
                <small>f√ºr AfA-Basis</small>
              </label>
              <div class="input-suffix">
                <input
                  type="number"
                  id="buildingShare"
                  step="1"
                  value="80"
                  placeholder="z. B. 80"
                />
                <span class="suffix">% KP</span>
              </div>
            </div>

            <div class="field">
              <label for="afaRate">
                <span>AfA-Satz</span>
                <small>linear p.a.</small>
              </label>
              <div class="input-suffix">
                <input
                  type="number"
                  id="afaRate"
                  step="0.1"
                  value="2"
                  placeholder="z. B. 2"
                />
                <span class="suffix">% p.a.</span>
              </div>
            </div>

            <div class="field">
              <label for="taxRate">
                <span>Steuersatz</span>
                <small>pers. Grenzsteuersatz</small>
              </label>
              <div class="input-suffix">
                <input
                  type="number"
                  id="taxRate"
                  step="1"
                  value="30"
                  placeholder="z. B. 30"
                />
                <span class="suffix">% </span>
              </div>
            </div>

            <div class="field">
              <label>
                <span>Steuer-Hinweis</span>
                <small>vereinfachte Einkommensteuer</small>
              </label>
              <div class="info-note">
                Eink√ºnfte aus Vermietung = Miete ‚àí nicht umlagef√§higes Hausgeld ‚àí Zinsen ‚àí AfA.
                R√ºcklagen & Tilgung sind nicht absetzbar. Ergebnis: grobe Steuerlast/Erstattung
                & Cashflow nach Steuer.
              </div>
            </div>
          </div>

          <div class="actions">
            <button type="button" class="btn-ghost" id="resetBtn">
              Reset
            </button>
            <button type="submit" class="btn-primary">
              <span class="btn-primary-icon">‚ö°</span>
              Deal-Qualit√§t berechnen
            </button>
          </div>
        </form>
      </section>

      <!-- RESULTS CARD -->
      <section class="card">
        <div class="card-header">
          <h2>Ergebnisse</h2>
          <span class="card-tag">Rendite ¬∑ NK ¬∑ Cashflow ¬∑ Risiko</span>
        </div>

        <div class="results-grid">
          <!-- RATIOS -->
          <div>
            <div class="ratio-grid">
              <div class="metric" id="metric-nk">
                <div class="metric-label">
                  <span>Nebenkosten gesamt</span>
                  <span class="metric-sub" id="nkPercentLabel"></span>
                </div>
                <div class="metric-value" id="nkTotal">‚Äì</div>
                <div class="metric-sub">
                  GrESt + Notar + Grundbuch + Makler + Sonstige
                </div>
              </div>

              <div class="metric" id="metric-pricePerSqm">
                <div class="metric-label">
                  <span>Kaufpreis / m¬≤</span>
                  <span class="metric-sub" id="equityRatioLabel"></span>
                </div>
                <div class="metric-value" id="pricePerSqm">‚Äì</div>
                <div class="metric-sub">Basis: Kaufpreis (ohne NK)</div>
              </div>

              <div class="metric" id="metric-rentPerSqm">
                <div class="metric-label">
                  <span>Miete / m¬≤</span>
                  <span class="metric-sub">netto, kalt</span>
                </div>
                <div class="metric-value" id="rentPerSqm">‚Äì</div>
                <div class="metric-sub">Monatliche Nettokaltmiete je m¬≤</div>
              </div>

              <div class="metric" id="metric-grossYield">
                <div class="metric-label">
                  <span>Bruttomietrendite</span>
                  <span class="metric-sub">vor Kosten</span>
                </div>
                <div class="metric-value" id="grossYield">‚Äì</div>
                <div class="metric-sub">
                  Jahreskaltmiete √∑ Kaufpreis
                </div>
              </div>

              <div class="metric" id="metric-netYield">
                <div class="metric-label">
                  <span>Nettomietrendite</span>
                  <span class="metric-sub">nach Hausgeld</span>
                </div>
                <div class="metric-value" id="netYield">‚Äì</div>
                <div class="metric-sub">
                  (Miete ‚àí Hausgeld) p.a. √∑ Kaufpreis
                </div>
              </div>
            </div>

            <!-- EXTRA KPIs -->
            <div class="ratio-grid">
              <div class="metric" id="metric-roe">
                <div class="metric-label">
                  <span>Eigenkapitalrendite</span>
                  <span class="metric-sub">CF nach Steuer + Tilgung</span>
                </div>
                <div class="metric-value" id="roeValue">‚Äì</div>
                <div class="metric-sub">
                  auf eingesetztes EK im Startjahr (nach Steuer)
                </div>
              </div>

              <div class="metric" id="metric-coc">
                <div class="metric-label">
                  <span>Cash-on-Cash Return</span>
                  <span class="metric-sub">CF nach Steuer / EK</span>
                </div>
                <div class="metric-value" id="cocValue">‚Äì</div>
                <div class="metric-sub">
                  j√§hrlicher Cashflow nach Steuer √∑ EK
                </div>
              </div>

              <div class="metric" id="metric-breakeven">
                <div class="metric-label">
                  <span>Break-even-Kaltmiete</span>
                  <span class="metric-sub">CF = 0 (vor Steuer)</span>
                </div>
                <div class="metric-value" id="breakevenRent">‚Äì</div>
                <div class="metric-sub">
                  Hausgeld + R√ºcklagen + Annuit√§t
                </div>
              </div>
            </div>
          </div>

          <!-- CASHFLOW & VERDICT -->
          <div>
            <div class="ratio-grid">
              <div class="metric" id="metric-monthlyDebt">
                <div class="metric-label">
                  <span>Annuit√§t gesamt</span>
                  <span class="metric-sub" id="annuityInfo"></span>
                </div>
                <div class="metric-value" id="monthlyDebt">‚Äì</div>
                <div class="metric-sub" id="interestPrincipalSplit">
                  ‚Äì
                </div>
              </div>

              <div class="metric" id="metric-cashflow">
                <div class="metric-label">
                  <span>Cashflow / Monat</span>
                  <span class="metric-sub" id="dscrLabel"></span>
                </div>
                <div class="metric-value" id="monthlyCashflow">‚Äì</div>
                <div class="metric-sub">
                  Kaltmiete ‚àí Hausgeld ‚àí R√ºcklagen ‚àí Annuit√§t (vor Steuer)
                </div>
              </div>

              <div class="metric" id="metric-cf-after-tax">
                <div class="metric-label">
                  <span>Cashflow nach Steuer</span>
                  <span class="metric-sub">inkl. AfA & Zinsen</span>
                </div>
                <div class="metric-value" id="cfAfterTax">‚Äì</div>
                <div class="metric-sub">
                  Cashflow vor Steuer ‚àí Einkommensteuer-Effekt
                </div>
              </div>
            </div>

            <p class="small-note" id="reservesInfo">
              R√ºcklagen: ‚Äì 
            </p>
            <p class="small-note" id="afaInfo">
              AfA & steuerlicher Effekt: ‚Äì
            </p>

            <div class="amort-section">
              <div class="amort-title">
                üìå Sondertilgung & Tilgungsplan
              </div>
              <p class="amort-subtext" id="prepaymentInfo">
                Keine Sondertilgung hinterlegt. Tilgungsplan wird nach Berechnung angezeigt.
              </p>
              <p class="small-note" id="amortSummary">
                Tilgungszusammenfassung (Restschuld, Zinsen, Tilgung) wird nach Berechnung angezeigt.
              </p>
              <details id="scheduleDetails">
                <summary>Tilgungsplan (Jahres√ºbersicht) anzeigen</summary>
                <div class="small-note">
                  Sondertilgung wird jeweils am Jahresende ber√ºcksichtigt. Werte gerundet.
                </div>
                <div class="table-wrapper">
                  <table id="scheduleTable"></table>
                </div>
                <button
                  type="button"
                  class="btn-ghost"
                  id="exportCsvBtn"
                  style="margin-top: 6px;"
                >
                  Tilgungsplan als CSV herunterladen
                </button>
              </details>
            </div>

            <div class="verdict" id="verdictBox">
              <div class="verdict-line">
                <span class="verdict-chip" id="verdictChip">Awaiting input</span>
                <span id="verdictHeadline">Zahlen eingeben, um den Deal zu bewerten.</span>
              </div>
              <p class="verdict-text" id="verdictText">
                Wir pr√ºfen eine Kombination aus Rendite, Nebenkosten, Leverage,
                Cashflow (vor & nach Steuer), AfA-Effekt und Schuldendienst. Ergebnis:
                eher solide, grenzwertig oder riskant ‚Äì keine Steuer- oder Rechtsberatung.
              </p>
            </div>

            <p class="small-note">
              ‚ö†Ô∏è Dieses Tool ersetzt keine individuelle Steuer-, Rechts- oder
              Finanzierungsberatung. Es dient als schneller Reality-Check f√ºr
              Investment-Entscheidungen.
            </p>
          </div>
        </div>
      </section>
    </main>
  </div>

<script>
/* ==========================================
   BASIC HELPERS
========================================== */

function parseNumber(value) {
  if (value === undefined || value === null) return 0;
  const cleaned = String(value).replace(",", ".").trim();
  const num = parseFloat(cleaned);
  return isNaN(num) ? 0 : num;
}

function formatCurrency(value) {
  if (!isFinite(value)) return "‚Äì";
  return value.toLocaleString("de-DE", {
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }) + " ‚Ç¨";
}

function formatCurrency2(value) {
  if (!isFinite(value)) return "‚Äì";
  return value.toLocaleString("de-DE", {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  }) + " ‚Ç¨";
}

function formatPercent(value) {
  if (!isFinite(value)) return "‚Äì";
  return value.toLocaleString("de-DE", {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  }) + " %";
}

function formatNumber(value, decimals = 2) {
  if (!isFinite(value)) return "‚Äì";
  return value.toLocaleString("de-DE", {
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals,
  });
}

function clearMetricClasses(el) {
  el.classList.remove("metric-highlight", "metric-warning", "metric-bad");
}

function updateVerdict(status, messageShort, messageLong) {
  const box = document.getElementById("verdictBox");
  const chip = document.getElementById("verdictChip");
  const headline = document.getElementById("verdictHeadline");
  const text = document.getElementById("verdictText");

  box.classList.remove("verdict-bad", "verdict-warning");
  chip.textContent = messageShort;

  if (status === "good") {
    headline.textContent = "Sieht nach einem soliden Investmentkandidaten aus.";
  } else if (status === "warning") {
    box.classList.add("verdict-warning");
    headline.textContent = "Borderline ‚Äì Lage, Zustand & Risiken genauer pr√ºfen.";
  } else if (status === "bad") {
    box.classList.add("verdict-bad");
    headline.textContent = "Vorsicht ‚Äì eher ein wackliger Deal.";
  } else {
    headline.textContent = "Zahlen eingeben, um den Deal zu bewerten.";
  }

  text.textContent = messageLong;
}

/* ==========================================
   AMORTISATION SCHEDULE
========================================== */

let lastSchedule = [];
let lastScheduleMeta = {};

function buildAmortizationSchedule(loanAmount, interestRate, monthlyAnnuity, prepayConfig, maxYears) {
  const schedule = [];
  if (!(loanAmount > 0 && interestRate >= 0 && monthlyAnnuity > 0)) return schedule;

  let balance = loanAmount;
  const rMonthly = interestRate / 100 / 12;
  const ann = monthlyAnnuity;
  const initialLoan = loanAmount;

  for (let year = 1; year <= maxYears && balance > 0.01; year++) {
    const startBalance = balance;
    let interestYear = 0;
    let principalYear = 0;

    for (let m = 0; m < 12 && balance > 0.01; m++) {
      const interestM = balance * rMonthly;
      let principalM = ann - interestM;
      if (principalM < 0) principalM = 0;
      if (principalM > balance) principalM = balance;

      balance -= principalM;
      interestYear += interestM;
      principalYear += principalM;
    }

    let extraPrepayment = 0;
    if (prepayConfig && prepayConfig.type !== "none" && balance > 0.01) {
      const limitYears = prepayConfig.years || 0;

      if (limitYears === 0 || year <= limitYears) {
        if (["pct2", "pct5", "pct10"].includes(prepayConfig.type)) {
          extraPrepayment = initialLoan * prepayConfig.percent;
        } else if (prepayConfig.type === "fixed") {
          extraPrepayment = prepayConfig.fixedAnnual;
        }

        if (extraPrepayment > balance) extraPrepayment = balance;
        balance -= extraPrepayment;
      }
    }

    schedule.push({
      year,
      startBalance,
      interestYear,
      principalYear,
      extraPrepayment,
      endBalance: balance,
    });

    if (balance <= 0.01) break;
  }
  return schedule;
}

function updateScheduleUI(schedule, fixationYears) {
  const amortSummaryEl = document.getElementById("amortSummary");
  const tableEl = document.getElementById("scheduleTable");
  const detailsEl = document.getElementById("scheduleDetails");

  if (!schedule || schedule.length === 0) {
    amortSummaryEl.textContent = "Kein Tilgungsplan berechnet ‚Äì bitte Darlehensdaten pr√ºfen.";
    tableEl.innerHTML = "";
    if (detailsEl) detailsEl.open = false;
    return;
  }

  let yearsForView = fixationYears > 0 ? fixationYears : schedule.length;

  let restAtFix = 0;
  let interestToFix = 0;
  let principalToFix = 0;
  let extraToFix = 0;

  schedule.forEach((row) => {
    if (row.year <= yearsForView) {
      interestToFix += row.interestYear;
      principalToFix += row.principalYear;
      extraToFix += row.extraPrepayment;
      restAtFix = row.endBalance;
    }
  });

  amortSummaryEl.textContent =
    "Restschuld nach " +
    yearsForView +
    " Jahren: " +
    formatCurrency(restAtFix) +
    " | Zinsen bis dahin: " +
    formatCurrency(interestToFix) +
    " | Tilgung (inkl. Sondertilgung): " +
    formatCurrency(principalToFix + extraToFix);

  let html = `
    <thead>
      <tr>
        <th>Jahr</th>
        <th>Restschuld Anfang</th>
        <th>Zinsen Jahr</th>
        <th>Tilgung Rate</th>
        <th>Sondertilgung</th>
        <th>Restschuld Ende</th>
      </tr>
    </thead><tbody>
  `;

  schedule.forEach((row) => {
    html += `
      <tr>
        <td>${row.year}</td>
        <td>${formatCurrency(row.startBalance)}</td>
        <td>${formatCurrency(row.interestYear)}</td>
        <td>${formatCurrency(row.principalYear)}</td>
        <td>${formatCurrency(row.extraPrepayment)}</td>
        <td>${formatCurrency(row.endBalance)}</td>
      </tr>`;
  });

  html += "</tbody>";
  tableEl.innerHTML = html;
}

/* ==========================================
   GRUNDERWERBSTEUER AUTO-FILL
========================================== */

const stateSelect = document.getElementById("stateSelect");
const grestInput = document.getElementById("grestPercent");

const grestByState = {
  BW: 5.0, BY: 3.5, BE: 6.0, BB: 6.5, HB: 5.0, HH: 5.5, HE: 6.0,
  MV: 6.0, NI: 5.0, NW: 6.5, RP: 5.0, SL: 6.5, SN: 3.5, ST: 5.0, SH: 6.5, TH: 6.5,
};

stateSelect.addEventListener("change", () => {
  const val = stateSelect.value;
  if (grestByState[val] !== undefined) {
    grestInput.value = grestByState[val].toString().replace(".", ",");
  }
});

/* ==========================================
   SONDERTILGUNG UI
========================================== */

const prepaymentTypeSelect = document.getElementById("prepaymentType");
const prepaymentFixedField = document.getElementById("prepaymentFixedField");

function updatePrepaymentFixedVisibility() {
  if (prepaymentTypeSelect.value === "fixed") {
    prepaymentFixedField.classList.remove("hidden");
  } else {
    prepaymentFixedField.classList.add("hidden");
    document.getElementById("prepaymentFixed").value = "";
  }
}
prepaymentTypeSelect.addEventListener("change", updatePrepaymentFixedVisibility);
updatePrepaymentFixedVisibility();

/* ==========================================
   MINI HEATMAP ‚Äì PLZ / LAGEFAKTOR
========================================== */

const demandRegions = {
  "10": { demand: "sehr angespannt", factor: 3, color: "#e02424", pos: 10 },
  "20": { demand: "sehr angespannt", factor: 3, color: "#e02424", pos: 10 },
  "60": { demand: "sehr angespannt", factor: 3, color: "#e02424", pos: 10 },
  "50": { demand: "angespannt", factor: 2, color: "#f59e0b", pos: 30 },
  "53": { demand: "angespannt", factor: 2, color: "#f59e0b", pos: 30 },
  "61": { demand: "angespannt", factor: 2, color: "#f59e0b", pos: 30 },
  "65": { demand: "angespannt", factor: 2, color: "#f59e0b", pos: 30 },
  "01": { demand: "√ºberh√∂hte Nachfrage", factor: 1, color: "#facc15", pos: 50 },
  "04": { demand: "√ºberh√∂hte Nachfrage", factor: 1, color: "#facc15", pos: 50 },
  "30": { demand: "√ºberh√∂hte Nachfrage", factor: 1, color: "#facc15", pos: 50 },
  "34": { demand: "ausgewogen", factor: 0, color: "#22c55e", pos: 70 },
  "48": { demand: "ausgewogen", factor: 0, color: "#22c55e", pos: 70 },
  "97": { demand: "ausgewogen", factor: 0, color: "#22c55e", pos: 70 },
  "17": { demand: "Angebots√ºberhang", factor: -2, color: "#3b82f6", pos: 90 },
  "26": { demand: "Angebots√ºberhang", factor: -2, color: "#3b82f6", pos: 90 },
  "27": { demand: "Angebots√ºberhang", factor: -2, color: "#3b82f6", pos: 90 },
};

const postcodeInput = document.getElementById("postcode");
const miniMarker = document.getElementById("miniHeatmapMarker");
const miniHint = document.getElementById("miniHeatmapHint");
const miniText = document.getElementById("miniHeatmapText");

window.currentLocationFactor = 0;

function updateMiniHeatmap(prefix) {
  const data = demandRegions[prefix];

  if (!data) {
    miniMarker.style.display = "none";
    miniText.textContent = "Keine Zuordnung gefunden.";
    window.currentLocationFactor = 0;
    return;
  }

  miniMarker.style.display = "block";
  miniMarker.style.left = data.pos + "%";

  miniText.innerHTML =
    `<span style="color:${data.color};font-weight:600;">‚óè ${data.demand}</span><br>
    <small>Lagefaktor: ${data.factor > 0 ? "+" + data.factor : data.factor}</small>`;

  miniHint.textContent = "Region erkannt. Nachfragelevel berechnet.";

  window.currentLocationFactor = data.factor;
}

postcodeInput.addEventListener("input", () => {
  const val = postcodeInput.value.trim();
  if (val.length >= 2) {
    updateMiniHeatmap(val.substring(0, 2));
  } else {
    miniMarker.style.display = "none";
    miniText.textContent = "Noch keine PLZ eingegeben.";
    miniHint.textContent = "Bitte PLZ eingeben, um Nachfragelevel zu berechnen.";
    window.currentLocationFactor = 0;
  }
});

/* ==========================================
   MAIN BERECHNUNG ‚Äì SUBMIT
========================================== */

document.getElementById("investment-form").addEventListener("submit", (event) => {
  event.preventDefault();

  /* BASIC INPUTS */
  const purchasePrice = parseNumber(document.getElementById("purchasePrice").value);
  const equity = parseNumber(document.getElementById("equity").value);
  const coldRentMonth = parseNumber(document.getElementById("coldRentMonth").value);
  const hausgeld = parseNumber(document.getElementById("hausgeld").value);
  const livingSpace = parseNumber(document.getElementById("livingSpace").value);
  const constructionYear = parseNumber(document.getElementById("constructionYear").value);

  /* ==========================================
     NEBENKOSTEN
  ========================================== */

  const grestPercentVal = parseNumber(grestInput.value);
  const notarPercentVal = parseNumber(document.getElementById("notarPercent").value);
  const grundbuchPercentVal = parseNumber(document.getElementById("grundbuchPercent").value);
  const maklerPercentVal = parseNumber(document.getElementById("maklerPercent").value);
  const otherCosts = parseNumber(document.getElementById("otherCosts").value);

  let nkGrest = purchasePrice * (grestPercentVal / 100);
  let nkNotar = purchasePrice * (notarPercentVal / 100);
  let nkGrundbuch = purchasePrice * (grundbuchPercentVal / 100);
  let nkMakler = purchasePrice * (maklerPercentVal / 100);
  const nkTotal = nkGrest + nkNotar + nkGrundbuch + nkMakler + otherCosts;

  const totalCost = purchasePrice + nkTotal;

  document.getElementById("nkTotal").textContent =
    nkTotal > 0 ? formatCurrency2(nkTotal) : "‚Äì";

  const nkPercent =
    purchasePrice > 0 ? (nkTotal * 100) / purchasePrice : NaN;

  document.getElementById("nkPercentLabel").textContent =
    isFinite(nkPercent) ? formatPercent(nkPercent) + " vom KP" : "";

  /* ==========================================
     ‚Ç¨/m¬≤ & RENDITE
  ========================================== */

  let pricePerSqm = purchasePrice > 0 && livingSpace > 0 ? purchasePrice / livingSpace : NaN;
  let rentPerSqm = coldRentMonth > 0 && livingSpace > 0 ? coldRentMonth / livingSpace : NaN;

  document.getElementById("pricePerSqm").textContent =
    isFinite(pricePerSqm) ? formatCurrency2(pricePerSqm).replace(" ‚Ç¨", " ‚Ç¨/m¬≤") : "‚Äì";

  document.getElementById("rentPerSqm").textContent =
    isFinite(rentPerSqm) ? formatCurrency2(rentPerSqm).replace(" ‚Ç¨", " ‚Ç¨/m¬≤") : "‚Äì";

  let grossYield = purchasePrice > 0 ? (coldRentMonth * 12 * 100) / purchasePrice : NaN;
  let netYield = purchasePrice > 0 ? ((coldRentMonth - hausgeld) * 12 * 100) / purchasePrice : NaN;

  document.getElementById("grossYield").textContent =
    isFinite(grossYield) ? formatPercent(grossYield) : "‚Äì";
  document.getElementById("netYield").textContent =
    isFinite(netYield) ? formatPercent(netYield) : "‚Äì";

  /* ==========================================
     EK-QUOTE
  ========================================== */

  let equityRatio =
    totalCost > 0 ? (equity * 100) / totalCost : equity > 0 ? (equity * 100) / purchasePrice : NaN;

  document.getElementById("equityRatioLabel").textContent =
    isFinite(equityRatio)
      ? `EK-Quote: ${formatPercent(equityRatio)} (auf Gesamtkosten)`
      : "";

  /* ==========================================
     DARLEHEN / ANNUIT√ÑT
  ========================================== */

  let loanAmount = parseNumber(document.getElementById("loanAmount").value);
  const interestRate = parseNumber(document.getElementById("interestRate").value);
  let principalRate = parseNumber(document.getElementById("principalRate").value);
  let monthlyInstallment = parseNumber(document.getElementById("monthlyInstallment").value);
  const fixationYears = parseNumber(document.getElementById("fixationYears").value) || 10;

  if (!loanAmount && totalCost > 0 && equity >= 0) {
    loanAmount = Math.max(totalCost - equity, 0);
    document.getElementById("loanAmount").value = Math.round(loanAmount);
  }

  let annualInterest = loanAmount > 0 ? (loanAmount * interestRate) / 100 : NaN;
  let annualDebtService = NaN;
  let monthlyDebt = NaN;

  if (loanAmount > 0) {
    if (monthlyInstallment > 0) {
      monthlyDebt = monthlyInstallment;
      annualDebtService = monthlyDebt * 12;

      const impliedPrincipal = Math.max(annualDebtService - annualInterest, 0);
      principalRate = (impliedPrincipal * 100) / loanAmount;
    } else if (principalRate > 0) {
      annualDebtService = loanAmount * ((interestRate + principalRate) / 100);
      monthlyDebt = annualDebtService / 12;
      monthlyInstallment = monthlyDebt;
      document.getElementById("monthlyInstallment").value = Math.round(monthlyInstallment);
    }
  }

  document.getElementById("monthlyDebt").textContent =
    isFinite(monthlyDebt) ? formatCurrency2(monthlyDebt) : "‚Äì";

  if (isFinite(annualDebtService)) {
    const annualPrincipalAmount = Math.max(annualDebtService - annualInterest, 0);
    document.getElementById("interestPrincipalSplit").textContent =
      `Zins: ${formatCurrency(annualInterest)} p.a. (${formatPercent(
        (annualInterest * 100) / annualDebtService
      )}), Tilgung: ${formatCurrency(
        annualPrincipalAmount
      )} p.a. (${formatPercent(
        (annualPrincipalAmount * 100) / annualDebtService
      )})`;
  } else {
    document.getElementById("interestPrincipalSplit").textContent = "‚Äì";
  }

  document.getElementById("annuityInfo").textContent =
    monthlyDebt > 0 ? "Eff. Annuit√§t: " + formatCurrency2(monthlyDebt) : "";

  /* ==========================================
     R√úCKLAGEN
  ========================================== */

  let reservesPerSqm = parseNumber(document.getElementById("reservesPerSqm").value);
  const reservesMonthly = parseNumber(document.getElementById("reservesMonthly").value);

  if (!reservesPerSqm && constructionYear > 0) {
    if (constructionYear < 1970) reservesPerSqm = 1.5;
    else if (constructionYear < 1990) reservesPerSqm = 1.2;
    else if (constructionYear < 2010) reservesPerSqm = 1.0;
    else reservesPerSqm = 0.7;

    document.getElementById("reservesPerSqm").value =
      reservesPerSqm.toString().replace(".", ",");
  }

  let reservesTotalMonth = reservesMonthly;
  if (livingSpace > 0 && reservesPerSqm > 0) {
    reservesTotalMonth += livingSpace * reservesPerSqm;
  }

  if (reservesTotalMonth > 0) {
    document.getElementById("reservesInfo").textContent =
      `R√ºcklagen: ${formatCurrency2(reservesTotalMonth).replace(" ‚Ç¨", " ‚Ç¨/Monat")}
      (${reservesPerSqm.toLocaleString("de-DE", { minimumFractionDigits: 2 })} ‚Ç¨/m¬≤¬∑Monat,
      Baujahr: ${constructionYear || "‚Äì"},
      + ${formatCurrency2(reservesMonthly).replace(" ‚Ç¨", " ‚Ç¨/Monat pauschal")})`;
  } else {
    document.getElementById("reservesInfo").textContent =
      "R√ºcklagen: keine R√ºcklagen hinterlegt (m¬≤ oder pauschal).";
  }

  /* ==========================================
     CASHFLOW (VOR STEUER)
  ========================================== */

  let monthlyCashflow = coldRentMonth - hausgeld - reservesTotalMonth - monthlyDebt;

  if (isFinite(monthlyCashflow)) {
    document.getElementById("monthlyCashflow").textContent =
      (monthlyCashflow >= 0 ? "+" : "") +
      formatCurrency2(monthlyCashflow).replace(" ‚Ç¨", " ‚Ç¨/Monat");
  } else {
    document.getElementById("monthlyCashflow").textContent = "‚Äì";
  }

  const netOperatingIncomeYear = (coldRentMonth - hausgeld) * 12;
  const dscr =
    isFinite(annualDebtService) && annualDebtService > 0
      ? netOperatingIncomeYear / annualDebtService
      : NaN;

  document.getElementById("dscrLabel").textContent =
    isFinite(dscr) ? "DSCR: " + formatNumber(dscr, 2) : "";

  /* ==========================================
     AfA + STEUERLICHE EINK√úNFTE
  ========================================== */

  const buildingShare = parseNumber(document.getElementById("buildingShare").value);
  const afaRate = parseNumber(document.getElementById("afaRate").value);
  const taxRate = parseNumber(document.getElementById("taxRate").value);

  let afaYear = 0;
  let afaMonth = 0;

  if (purchasePrice > 0 && buildingShare > 0 && afaRate > 0) {
    const buildingValue = purchasePrice * (buildingShare / 100);
    afaYear = buildingValue * (afaRate / 100);
    afaMonth = afaYear / 12;
  }

  const incomeRentYear = coldRentMonth * 12;
  const costHausgeldYear = hausgeld * 12;
  const interestCostYear = annualInterest || 0;

  // steuerlich relevante Eink√ºnfte aus Vermietung (vereinfachte ESt)
  const taxableIncome =
    incomeRentYear
    - costHausgeldYear
    - interestCostYear
    - afaYear;

  const taxEffectYear = taxableIncome * (taxRate / 100);
  const taxEffectMonth = taxEffectYear / 12;

  if (purchasePrice > 0 && coldRentMonth > 0 && taxRate > 0) {
    document.getElementById("afaInfo").textContent =
      `AfA: ${formatCurrency(afaYear)} p.a. | Eink√ºnfte aus Vermietung: ${
        formatCurrency2(taxableIncome).replace(" ‚Ç¨", " ‚Ç¨/Jahr")
      } | Steuerlicher Effekt: ${
        taxEffectYear >= 0 ? "Steuerlast ca. " : "Steuererstattung ca. "
      } ${formatCurrency2(Math.abs(taxEffectMonth)).replace(" ‚Ç¨", " ‚Ç¨/Monat")}`;
  } else {
    document.getElementById("afaInfo").textContent =
      "AfA & steuerlicher Effekt: keine oder unvollst√§ndige Angaben.";
  }

  /* ==========================================
     CASHFLOW NACH STEUER
  ========================================== */

  let cfAfterTax = NaN;
  if (isFinite(monthlyCashflow) && isFinite(taxEffectMonth)) {
    // Steuerlast (positiv) mindert CF, Erstattung (negativ) erh√∂ht CF
    cfAfterTax = monthlyCashflow - taxEffectMonth;

    document.getElementById("cfAfterTax").textContent =
      (cfAfterTax >= 0 ? "+" : "") +
      formatCurrency2(cfAfterTax).replace(" ‚Ç¨", " ‚Ç¨/Monat");
  } else {
    document.getElementById("cfAfterTax").textContent = "‚Äì";
  }

  /* ==========================================
     KPIs (ROE / CoC NACH STEUER)
  ========================================== */

  const annualCashflowBeforeTax = monthlyCashflow * 12;
  const annualCashflowAfterTax = cfAfterTax * 12;
  const annualPrincipalAmount =
    Math.max((annualDebtService || 0) - (annualInterest || 0), 0);

  let roe = NaN;
  let coc = NaN;

  if (equity > 0 && isFinite(annualCashflowAfterTax)) {
    roe = ((annualCashflowAfterTax + annualPrincipalAmount) * 100) / equity;
    coc = (annualCashflowAfterTax * 100) / equity;
  }

  document.getElementById("roeValue").textContent =
    isFinite(roe) ? formatPercent(roe) : "‚Äì";
  document.getElementById("cocValue").textContent =
    isFinite(coc) ? formatPercent(coc) : "‚Äì";

  const breakevenRentVal =
    hausgeld + reservesTotalMonth + (isFinite(monthlyDebt) ? monthlyDebt : 0);

  document.getElementById("breakevenRent").textContent =
    isFinite(breakevenRentVal)
      ? formatCurrency2(breakevenRentVal).replace(" ‚Ç¨", " ‚Ç¨/Monat")
      : "‚Äì";

  /* ==========================================
     SONDERTILGUNG
  ========================================== */

  const prepaymentType = prepaymentTypeSelect.value;
  const prepaymentYearsInput = parseNumber(document.getElementById("prepaymentYears").value);
  const prepaymentYears = prepaymentYearsInput > 0 ? prepaymentYearsInput : 0;
  const prepaymentFixed = parseNumber(document.getElementById("prepaymentFixed").value);

  let prepayPercent = 0;
  if (prepaymentType === "pct5") prepayPercent = 0.05;
  if (prepaymentType === "pct2") prepayPercent = 0.02;
  if (prepaymentType === "pct10") prepayPercent = 0.1;

  let prepayAnnualExample = 0;
  if (loanAmount > 0) {
    if (prepayPercent > 0) prepayAnnualExample = loanAmount * prepayPercent;
    else if (prepaymentType === "fixed") prepayAnnualExample = prepaymentFixed;
  }

  const prepaymentAmountInfo = document.getElementById("prepaymentAmountInfo");
  const prepaymentInfoRes = document.getElementById("prepaymentInfo");

  if (!loanAmount || prepaymentType === "none") {
    prepaymentAmountInfo.textContent = "Keine Sondertilgung hinterlegt.";
    prepaymentInfoRes.textContent =
      "Keine Sondertilgung hinterlegt. Tilgungsplan zeigt reine Annuit√§ten-Tilgung.";
  } else {
    const label =
      prepaymentType === "pct5"
        ? "5 % p.a. vom Darlehen"
        : prepaymentType === "pct2"
        ? "2 % p.a. vom Darlehen"
        : prepaymentType === "pct10"
        ? "10 % p.a. vom Darlehen"
        : "Fester Betrag p.a.";

    const yrsText =
      prepaymentYears > 0
        ? `in den ersten ${prepaymentYears} Jahren`
        : "√ºber die gesamte Laufzeit";

    if (prepayAnnualExample > 0) {
      const annualText = formatCurrency2(prepayAnnualExample).replace(" ‚Ç¨", " ‚Ç¨/Jahr");
      prepaymentAmountInfo.textContent =
        `${label} ‚Üí aktuell ca. ${annualText} (${yrsText}).`;
      prepaymentInfoRes.textContent =
        `Ber√ºcksichtigte Sondertilgung: ${label}, aktuell ca. ${annualText} (${yrsText}).`;
    } else {
      prepaymentAmountInfo.textContent =
        `${label} (keine eindeutige H√∂he berechenbar).`;
      prepaymentInfoRes.textContent =
        `Ber√ºcksichtigte Sondertilgung: ${label} (${yrsText}).`;
    }
  }

  /* ==========================================
     TILGUNGSPLAN
  ========================================== */

  let schedule = [];

  if (loanAmount > 0 && interestRate > 0 && monthlyDebt > 0) {
    const prepayConfig = {
      type: prepaymentType,
      percent: prepayPercent,
      fixedAnnual: prepaymentType === "fixed" ? prepaymentFixed : 0,
      years: prepaymentYears,
    };

    schedule = buildAmortizationSchedule(
      loanAmount,
      interestRate,
      monthlyDebt,
      prepayConfig,
      40
    );

    lastSchedule = schedule;
    lastScheduleMeta = { loanAmount, interestRate, monthlyDebt, prepayConfig };

    updateScheduleUI(schedule, fixationYears);
  } else {
    lastSchedule = [];
    lastScheduleMeta = {};
    updateScheduleUI([], fixationYears);
  }

  /* ==========================================
     METRIC HIGHLIGHTS
  ========================================== */

  const mGross = document.getElementById("metric-grossYield");
  const mNet = document.getElementById("metric-netYield");
  const mCF = document.getElementById("metric-cashflow");
  const mDebt = document.getElementById("metric-monthlyDebt");
  const mCFAT = document.getElementById("metric-cf-after-tax");

  [mGross, mNet, mCF, mDebt, mCFAT].forEach(clearMetricClasses);

  if (isFinite(grossYield)) {
    if (grossYield >= 4) mGross.classList.add("metric-highlight");
    else if (grossYield >= 3) mGross.classList.add("metric-warning");
    else mGross.classList.add("metric-bad");
  }

  if (isFinite(netYield)) {
    if (netYield >= 3) mNet.classList.add("metric-highlight");
    else if (netYield >= 2) mNet.classList.add("metric-warning");
    else mNet.classList.add("metric-bad");
  }

  if (isFinite(monthlyCashflow)) {
    if (monthlyCashflow > 0) mCF.classList.add("metric-highlight");
    else if (monthlyCashflow > -100) mCF.classList.add("metric-warning");
    else mCF.classList.add("metric-bad");
  }

  if (isFinite(cfAfterTax)) {
    if (cfAfterTax > 0) mCFAT.classList.add("metric-highlight");
    else if (cfAfterTax > -100) mCFAT.classList.add("metric-warning");
    else mCFAT.classList.add("metric-bad");
  }

  if (isFinite(dscr)) {
    if (dscr >= 1.2) mDebt.classList.add("metric-highlight");
    else if (dscr >= 1) mDebt.classList.add("metric-warning");
    else mDebt.classList.add("metric-bad");
  }

  /* ==========================================
     VERDICT ‚Äì mit LAGEFAKTOR & NACH STEUER
  ========================================== */

  if (!purchasePrice || !coldRentMonth || !livingSpace) {
    updateVerdict(
      "neutral",
      "Awaiting input",
      "Bitte mindestens Kaufpreis, Kaltmiete, Wohnfl√§che und Darlehensdaten eingeben."
    );
    return;
  }

  const L = window.currentLocationFactor || 0;

  const grossYieldAdjGood = 4 + L * 0.3;
  const netYieldAdjGood = 3 + L * 0.25;

  const grossYieldAdjWarn = 3 + L * 0.3;
  const netYieldAdjWarn = 2 + L * 0.25;

  const cfCritical = -150 + L * 20;
  const cfAfterTaxCritical = -100 + L * 20;

  let status = "warning";
  let shortMsg = "Borderline";
  let longMsg =
    "Die Kennzahlen liegen im mittleren Bereich. Schau genauer auf Lage, Zustand, Finanzierung, R√ºcklagen, Steuer-Effekt und Risiko.";

  if (
    isFinite(grossYield) &&
    isFinite(netYield) &&
    isFinite(cfAfterTax) &&
    isFinite(dscr)
  ) {
    if (
      grossYield >= grossYieldAdjGood &&
      netYield >= netYieldAdjGood &&
      cfAfterTax >= 0 &&
      dscr >= 1.2
    ) {
      status = "good";
      shortMsg = "Strong deal";
      longMsg =
        `Rendite, Cashflow nach Steuer und Schuldendienst wirken solide ‚Äì verst√§rkt durch den Lagefaktor (${L}).`;
    } else if (
      grossYield < grossYieldAdjWarn ||
      netYield < netYieldAdjWarn ||
      monthlyCashflow < cfCritical ||
      cfAfterTax < cfAfterTaxCritical ||
      dscr < 1
    ) {
      status = "bad";
      shortMsg = "Risky deal";
      longMsg =
        `Mindestens eine Kennzahl ist kritisch. Lagefaktor: ${L}. Preis, Miete, Steuer-Effekt oder Finanzierung pr√ºfen.`;
    }
  }

  updateVerdict(status, shortMsg, longMsg);
});

/* ==========================================
   CSV EXPORT
========================================== */

document.getElementById("exportCsvBtn").addEventListener("click", () => {
  if (!lastSchedule || lastSchedule.length === 0) {
    alert("Bitte zuerst den Deal berechnen.");
    return;
  }

  let csv = "Jahr;Restschuld Anfang;Zinsen Jahr;Tilgung Rate;Sondertilgung;Restschuld Ende\n";

  lastSchedule.forEach((row) => {
    csv +=
      [
        row.year,
        row.startBalance.toFixed(2),
        row.interestYear.toFixed(2),
        row.principalYear.toFixed(2),
        row.extraPrepayment.toFixed(2),
        row.endBalance.toFixed(2),
      ].join(";") + "\n";
  });

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "Tilgungsplan.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
});

/* ==========================================
   RESET
========================================== */

document.getElementById("resetBtn").addEventListener("click", () => {
  document.getElementById("investment-form").reset();

  const idsToClear = [
    "nkTotal", "nkPercentLabel", "pricePerSqm", "rentPerSqm",
    "grossYield", "netYield", "equityRatioLabel", "monthlyDebt",
    "interestPrincipalSplit", "monthlyCashflow", "annuityInfo",
    "dscrLabel", "roeValue", "cocValue", "breakevenRent",
    "amortSummary", "prepaymentAmountInfo", "prepaymentInfo",
    "cfAfterTax"
  ];

  idsToClear.forEach(id => {
    document.getElementById(id).textContent = "‚Äì";
  });

  document.getElementById("scheduleTable").innerHTML = "";
  document.getElementById("reservesInfo").textContent = "R√ºcklagen: ‚Äì";
  document.getElementById("afaInfo").textContent = "AfA & steuerlicher Effekt: ‚Äì";
  document.getElementById("miniHeatmapText").textContent = "Noch keine PLZ eingegeben.";
  document.getElementById("miniHeatmapHint").textContent =
    "Bitte PLZ eingeben, um Nachfragelevel berechnen zu k√∂nnen.";
  document.getElementById("miniHeatmapMarker").style.display = "none";

  ["metric-grossYield", "metric-netYield", "metric-cashflow", "metric-monthlyDebt", "metric-cf-after-tax"]
    .forEach(id => clearMetricClasses(document.getElementById(id)));

  lastSchedule = [];
  lastScheduleMeta = {};
  window.currentLocationFactor = 0;

  updatePrepaymentFixedVisibility();

  updateVerdict(
    "neutral",
    "Awaiting input",
    "Wir pr√ºfen eine Kombination aus Rendite, Nebenkosten, Leverage, Cashflow (vor & nach Steuer), AfA-Effekt und Schuldendienst."
  );
});

/* ==========================================
   THEME TOGGLE
========================================== */
const themeToggle = document.getElementById("themeToggle");

themeToggle.addEventListener("change", () => {
  if (themeToggle.checked) {
    document.body.classList.add("light");
    localStorage.setItem("theme", "light");
  } else {
    document.body.classList.remove("light");
    localStorage.setItem("theme", "dark");
  }
});

// beim Laden Zustand wiederherstellen
if (localStorage.getItem("theme") === "light") {
  document.body.classList.add("light");
  themeToggle.checked = true;
}

</script>

</body>
</html>


